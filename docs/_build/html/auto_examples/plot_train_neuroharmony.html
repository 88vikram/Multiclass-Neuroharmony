

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Train your own Neuroharmony model &mdash; Neuroharmony 0.0.1 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/project-template.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../_static/gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../_static/gallery-dataframe.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/js/copybutton.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Apply a pre-trained Neuroharmony model" href="plot_neuroharmony_trained.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> Neuroharmony
          

          
          </a>

          
            
            
              <div class="version">
                0.0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Neuroharmony</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../neuroharmony.html">Neuroharmony’s documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api.html">Neuroharmony API</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial - Examples</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">General examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="plot_data_in_the_neuroharmony_format.html">Prepare data for Neuroharmony</a></li>
<li class="toctree-l2"><a class="reference internal" href="plot_neuroharmony_trained.html">Apply a pre-trained Neuroharmony model</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Train your own Neuroharmony model</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Neuroharmony</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">General examples</a> &raquo;</li>
        
      <li>Train your own Neuroharmony model</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/auto_examples/plot_train_neuroharmony.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-auto-examples-plot-train-neuroharmony-py"><span class="std std-ref">here</span></a>     to download the full example code</p>
</div>
<div class="sphx-glr-example-title section" id="train-your-own-neuroharmony-model">
<span id="sphx-glr-auto-examples-plot-train-neuroharmony-py"></span><h1>Train your own Neuroharmony model<a class="headerlink" href="#train-your-own-neuroharmony-model" title="Permalink to this headline">¶</a></h1>
<p>In this example, we show how to train an instance of Neuroharmony. The dataset we use here is very limited, and the
hyperparameters are not well explored, so we do not expect good results. This is an example of how to format the data
and run the training.</p>
<img alt="Kolmogorov-Smirnov test (p-value)" class="sphx-glr-single-img" src="../_images/sphx_glr_plot_train_neuroharmony_001.png" />
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>0.00iB [00:00, ?iB/s]
161kiB [00:00, 1.55MiB/s]
891kiB [00:00, 2.01MiB/s]
967kiB [00:00, 4.51MiB/s]

Randomized search of Neuroharmony hyperparameters:   0%|          | 0/101 [00:00&lt;?, ?it/s]
Randomized search of Neuroharmony hyperparameters:   1%|          | 1/101 [00:01&lt;03:17,  1.98s/it]
Randomized search of Neuroharmony hyperparameters:   2%|1         | 2/101 [00:02&lt;02:28,  1.50s/it]
Randomized search of Neuroharmony hyperparameters:   3%|2         | 3/101 [00:02&lt;01:58,  1.21s/it]
Randomized search of Neuroharmony hyperparameters:   4%|3         | 4/101 [00:03&lt;01:38,  1.01s/it]
Randomized search of Neuroharmony hyperparameters:   5%|4         | 5/101 [00:03&lt;01:17,  1.24it/s]
Randomized search of Neuroharmony hyperparameters:   6%|5         | 6/101 [00:04&lt;01:04,  1.46it/s]
Randomized search of Neuroharmony hyperparameters:   7%|6         | 7/101 [00:04&lt;00:55,  1.68it/s]
Randomized search of Neuroharmony hyperparameters:   8%|7         | 8/101 [00:04&lt;00:48,  1.92it/s]
Randomized search of Neuroharmony hyperparameters:   9%|8         | 9/101 [00:05&lt;00:44,  2.05it/s]
Randomized search of Neuroharmony hyperparameters:  10%|9         | 10/101 [00:05&lt;00:41,  2.21it/s]
Randomized search of Neuroharmony hyperparameters:  11%|#         | 11/101 [00:06&lt;00:41,  2.19it/s]
Randomized search of Neuroharmony hyperparameters:  12%|#1        | 12/101 [00:06&lt;00:39,  2.28it/s]
Randomized search of Neuroharmony hyperparameters:  13%|#2        | 13/101 [00:06&lt;00:37,  2.34it/s]
Randomized search of Neuroharmony hyperparameters:  14%|#3        | 14/101 [00:07&lt;00:35,  2.43it/s]
Randomized search of Neuroharmony hyperparameters:  15%|#4        | 15/101 [00:07&lt;00:33,  2.56it/s]
Randomized search of Neuroharmony hyperparameters:  16%|#5        | 16/101 [00:08&lt;00:33,  2.53it/s]
Randomized search of Neuroharmony hyperparameters:  17%|#6        | 17/101 [00:08&lt;00:34,  2.44it/s]
Randomized search of Neuroharmony hyperparameters:  18%|#7        | 18/101 [00:08&lt;00:32,  2.55it/s]
Randomized search of Neuroharmony hyperparameters:  19%|#8        | 19/101 [00:09&lt;00:35,  2.34it/s]
Randomized search of Neuroharmony hyperparameters:  20%|#9        | 20/101 [00:09&lt;00:37,  2.15it/s]
Randomized search of Neuroharmony hyperparameters:  21%|##        | 21/101 [00:10&lt;00:35,  2.28it/s]
Randomized search of Neuroharmony hyperparameters:  22%|##1       | 22/101 [00:10&lt;00:32,  2.46it/s]
Randomized search of Neuroharmony hyperparameters:  23%|##2       | 23/101 [00:11&lt;00:31,  2.49it/s]
Randomized search of Neuroharmony hyperparameters:  24%|##3       | 24/101 [00:11&lt;00:30,  2.51it/s]
Randomized search of Neuroharmony hyperparameters:  25%|##4       | 25/101 [00:11&lt;00:30,  2.47it/s]
Randomized search of Neuroharmony hyperparameters:  26%|##5       | 26/101 [00:12&lt;00:30,  2.46it/s]
Randomized search of Neuroharmony hyperparameters:  27%|##6       | 27/101 [00:12&lt;00:28,  2.57it/s]
Randomized search of Neuroharmony hyperparameters:  28%|##7       | 28/101 [00:13&lt;00:28,  2.54it/s]
Randomized search of Neuroharmony hyperparameters:  29%|##8       | 29/101 [00:13&lt;00:28,  2.52it/s]
Randomized search of Neuroharmony hyperparameters:  30%|##9       | 30/101 [00:13&lt;00:27,  2.60it/s]
Randomized search of Neuroharmony hyperparameters:  31%|###       | 31/101 [00:14&lt;00:26,  2.60it/s]
Randomized search of Neuroharmony hyperparameters:  32%|###1      | 32/101 [00:14&lt;00:25,  2.69it/s]
Randomized search of Neuroharmony hyperparameters:  33%|###2      | 33/101 [00:14&lt;00:25,  2.62it/s]
Randomized search of Neuroharmony hyperparameters:  34%|###3      | 34/101 [00:15&lt;00:25,  2.65it/s]
Randomized search of Neuroharmony hyperparameters:  35%|###4      | 35/101 [00:15&lt;00:24,  2.66it/s]
Randomized search of Neuroharmony hyperparameters:  36%|###5      | 36/101 [00:16&lt;00:26,  2.49it/s]
Randomized search of Neuroharmony hyperparameters:  37%|###6      | 37/101 [00:16&lt;00:25,  2.53it/s]
Randomized search of Neuroharmony hyperparameters:  38%|###7      | 38/101 [00:16&lt;00:24,  2.59it/s]
Randomized search of Neuroharmony hyperparameters:  39%|###8      | 39/101 [00:17&lt;00:25,  2.46it/s]
Randomized search of Neuroharmony hyperparameters:  40%|###9      | 40/101 [00:17&lt;00:25,  2.44it/s]
Randomized search of Neuroharmony hyperparameters:  41%|####      | 41/101 [00:18&lt;00:25,  2.34it/s]
Randomized search of Neuroharmony hyperparameters:  42%|####1     | 42/101 [00:18&lt;00:24,  2.38it/s]
Randomized search of Neuroharmony hyperparameters:  43%|####2     | 43/101 [00:19&lt;00:24,  2.36it/s]
Randomized search of Neuroharmony hyperparameters:  44%|####3     | 44/101 [00:19&lt;00:23,  2.46it/s]
Randomized search of Neuroharmony hyperparameters:  45%|####4     | 45/101 [00:19&lt;00:22,  2.52it/s]
Randomized search of Neuroharmony hyperparameters:  46%|####5     | 46/101 [00:20&lt;00:21,  2.61it/s]
Randomized search of Neuroharmony hyperparameters:  47%|####6     | 47/101 [00:20&lt;00:22,  2.44it/s]
Randomized search of Neuroharmony hyperparameters:  48%|####7     | 48/101 [00:20&lt;00:20,  2.57it/s]
Randomized search of Neuroharmony hyperparameters:  49%|####8     | 49/101 [00:21&lt;00:19,  2.62it/s]
Randomized search of Neuroharmony hyperparameters:  50%|####9     | 50/101 [00:21&lt;00:20,  2.52it/s]
Randomized search of Neuroharmony hyperparameters:  50%|#####     | 51/101 [00:22&lt;00:19,  2.61it/s]
Randomized search of Neuroharmony hyperparameters:  51%|#####1    | 52/101 [00:22&lt;00:19,  2.57it/s]
Randomized search of Neuroharmony hyperparameters:  52%|#####2    | 53/101 [00:22&lt;00:18,  2.56it/s]
Randomized search of Neuroharmony hyperparameters:  53%|#####3    | 54/101 [00:23&lt;00:19,  2.41it/s]
Randomized search of Neuroharmony hyperparameters:  54%|#####4    | 55/101 [00:23&lt;00:18,  2.52it/s]
Randomized search of Neuroharmony hyperparameters:  55%|#####5    | 56/101 [00:24&lt;00:18,  2.46it/s]
Randomized search of Neuroharmony hyperparameters:  56%|#####6    | 57/101 [00:24&lt;00:17,  2.51it/s]
Randomized search of Neuroharmony hyperparameters:  57%|#####7    | 58/101 [00:24&lt;00:16,  2.54it/s]
Randomized search of Neuroharmony hyperparameters:  58%|#####8    | 59/101 [00:25&lt;00:17,  2.45it/s]
Randomized search of Neuroharmony hyperparameters:  59%|#####9    | 60/101 [00:25&lt;00:18,  2.27it/s]
Randomized search of Neuroharmony hyperparameters:  60%|######    | 61/101 [00:26&lt;00:17,  2.30it/s]
Randomized search of Neuroharmony hyperparameters:  61%|######1   | 62/101 [00:26&lt;00:17,  2.24it/s]
Randomized search of Neuroharmony hyperparameters:  62%|######2   | 63/101 [00:27&lt;00:16,  2.26it/s]
Randomized search of Neuroharmony hyperparameters:  63%|######3   | 64/101 [00:27&lt;00:15,  2.40it/s]
Randomized search of Neuroharmony hyperparameters:  64%|######4   | 65/101 [00:27&lt;00:14,  2.45it/s]
Randomized search of Neuroharmony hyperparameters:  65%|######5   | 66/101 [00:28&lt;00:14,  2.47it/s]
Randomized search of Neuroharmony hyperparameters:  66%|######6   | 67/101 [00:28&lt;00:13,  2.48it/s]
Randomized search of Neuroharmony hyperparameters:  67%|######7   | 68/101 [00:29&lt;00:12,  2.57it/s]
Randomized search of Neuroharmony hyperparameters:  68%|######8   | 69/101 [00:29&lt;00:12,  2.56it/s]
Randomized search of Neuroharmony hyperparameters:  69%|######9   | 70/101 [00:29&lt;00:12,  2.54it/s]
Randomized search of Neuroharmony hyperparameters:  70%|#######   | 71/101 [00:30&lt;00:11,  2.53it/s]
Randomized search of Neuroharmony hyperparameters:  71%|#######1  | 72/101 [00:30&lt;00:11,  2.57it/s]
Randomized search of Neuroharmony hyperparameters:  72%|#######2  | 73/101 [00:31&lt;00:10,  2.59it/s]
Randomized search of Neuroharmony hyperparameters:  73%|#######3  | 74/101 [00:31&lt;00:10,  2.51it/s]
Randomized search of Neuroharmony hyperparameters:  74%|#######4  | 75/101 [00:31&lt;00:10,  2.48it/s]
Randomized search of Neuroharmony hyperparameters:  75%|#######5  | 76/101 [00:32&lt;00:09,  2.54it/s]
Randomized search of Neuroharmony hyperparameters:  76%|#######6  | 77/101 [00:32&lt;00:10,  2.38it/s]
Randomized search of Neuroharmony hyperparameters:  77%|#######7  | 78/101 [00:33&lt;00:09,  2.47it/s]
Randomized search of Neuroharmony hyperparameters:  78%|#######8  | 79/101 [00:33&lt;00:08,  2.46it/s]
Randomized search of Neuroharmony hyperparameters:  79%|#######9  | 80/101 [00:33&lt;00:08,  2.40it/s]
Randomized search of Neuroharmony hyperparameters:  80%|########  | 81/101 [00:34&lt;00:08,  2.36it/s]
Randomized search of Neuroharmony hyperparameters:  81%|########1 | 82/101 [00:34&lt;00:07,  2.42it/s]
Randomized search of Neuroharmony hyperparameters:  82%|########2 | 83/101 [00:35&lt;00:07,  2.52it/s]
Randomized search of Neuroharmony hyperparameters:  83%|########3 | 84/101 [00:35&lt;00:06,  2.61it/s]
Randomized search of Neuroharmony hyperparameters:  84%|########4 | 85/101 [00:35&lt;00:06,  2.65it/s]
Randomized search of Neuroharmony hyperparameters:  85%|########5 | 86/101 [00:36&lt;00:05,  2.73it/s]
Randomized search of Neuroharmony hyperparameters:  86%|########6 | 87/101 [00:36&lt;00:05,  2.75it/s]
Randomized search of Neuroharmony hyperparameters:  87%|########7 | 88/101 [00:37&lt;00:05,  2.50it/s]
Randomized search of Neuroharmony hyperparameters:  88%|########8 | 89/101 [00:37&lt;00:04,  2.58it/s]
Randomized search of Neuroharmony hyperparameters:  89%|########9 | 90/101 [00:37&lt;00:04,  2.40it/s]
Randomized search of Neuroharmony hyperparameters:  90%|######### | 91/101 [00:38&lt;00:04,  2.37it/s]
Randomized search of Neuroharmony hyperparameters:  91%|#########1| 92/101 [00:38&lt;00:03,  2.50it/s]
Randomized search of Neuroharmony hyperparameters:  92%|#########2| 93/101 [00:39&lt;00:03,  2.47it/s]
Randomized search of Neuroharmony hyperparameters:  93%|#########3| 94/101 [00:39&lt;00:03,  2.32it/s]
Randomized search of Neuroharmony hyperparameters:  94%|#########4| 95/101 [00:39&lt;00:02,  2.29it/s]
Randomized search of Neuroharmony hyperparameters:  95%|#########5| 96/101 [00:40&lt;00:02,  2.34it/s]
Randomized search of Neuroharmony hyperparameters:  96%|#########6| 97/101 [00:40&lt;00:01,  2.35it/s]
Randomized search of Neuroharmony hyperparameters:  97%|#########7| 98/101 [00:41&lt;00:01,  2.39it/s]
Randomized search of Neuroharmony hyperparameters:  98%|#########8| 99/101 [00:41&lt;00:00,  2.42it/s]
Randomized search of Neuroharmony hyperparameters:  99%|#########9| 100/101 [00:42&lt;00:00,  2.48it/s]
Randomized search of Neuroharmony hyperparameters: 100%|##########| 101/101 [00:42&lt;00:00,  2.55it/s]
/home/rgd/git/neuroharmony/neuroharmony/models/harmonization.py:459: UserWarning: Some of the subject are out of the training range. See Neuroharmony.subjects_out_of_range_ for a list of the affected subjects.
  &quot;Some of the subject are out of the training range. &quot;
/home/rgd/git/neuroharmony/examples/plot_train_neuroharmony.py:67: RuntimeWarning: All-NaN slice encountered
  MIN_KS_ORIGINAL = pd.DataFrame(np.nanmin(KS_ORIGINAL_ARRAY, axis=2), index=scanners, columns=scanners).fillna(0)
/home/rgd/git/neuroharmony/examples/plot_train_neuroharmony.py:68: RuntimeWarning: All-NaN slice encountered
  MIN_KS_HARMONIZED = pd.DataFrame(np.nanmin(KS_HARMONIZED_ARRAY, axis=2), index=scanners, columns=scanners).fillna(0)
/home/rgd/git/neuroharmony/examples/plot_train_neuroharmony.py:85: UserWarning: Matplotlib is currently using agg, which is a non-GUI backend, so cannot show the figure.
  plt.show()
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">LogNorm</span>
<span class="kn">from</span> <span class="nn">neuroharmony</span> <span class="kn">import</span> <span class="n">exclude_single_subject_groups</span><span class="p">,</span> <span class="n">fetch_sample</span><span class="p">,</span> <span class="n">ks_test_grid</span><span class="p">,</span> <span class="n">Neuroharmony</span>
<span class="kn">from</span> <span class="nn">neuroharmony.data.rois</span> <span class="kn">import</span> <span class="n">rois</span>
<span class="kn">from</span> <span class="nn">seaborn</span> <span class="kn">import</span> <span class="n">heatmap</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="c1"># Load the data.</span>
<span class="c1"># You can do as you wish, as long as the input to Neuroharmony is a NDFrame (pandas).</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">fetch_sample</span><span class="p">()</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">rois</span>
<span class="n">covariates</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Gender&quot;</span><span class="p">,</span> <span class="s2">&quot;scanner&quot;</span><span class="p">,</span> <span class="s2">&quot;Age&quot;</span><span class="p">]</span>
<span class="n">exclude_vars</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">X</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span> <span class="o">+</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">X</span><span class="o">.</span><span class="n">dtypes</span> <span class="o">==</span> <span class="s1">&#39;O&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Dataset&#39;</span><span class="p">,</span> <span class="s1">&#39;Diagn&#39;</span><span class="p">]</span>
<span class="n">regression_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">covariates</span> <span class="o">+</span> <span class="n">features</span> <span class="o">+</span> <span class="n">exclude_vars</span><span class="p">]</span>
<span class="n">eliminate_variance</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;scanner&quot;</span><span class="p">]</span>

<span class="n">X</span><span class="o">.</span><span class="n">Age</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">Age</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">scanners</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">scanner</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="n">n_scanners</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">scanners</span><span class="p">)</span>
<span class="c1"># Split train and test leaving one scanner out.</span>
<span class="n">train_bool</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">scanner</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">scanners</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
<span class="n">test_bool</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">scanner</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">scanners</span><span class="p">[:</span><span class="mi">1</span><span class="p">])</span>
<span class="n">X_train_split</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">train_bool</span><span class="p">][</span><span class="n">regression_features</span> <span class="o">+</span> <span class="n">covariates</span> <span class="o">+</span> <span class="n">rois</span><span class="p">]</span>
<span class="n">X_test_split</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">test_bool</span><span class="p">][</span><span class="n">regression_features</span> <span class="o">+</span> <span class="n">covariates</span> <span class="o">+</span> <span class="n">rois</span><span class="p">]</span>
<span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span> <span class="o">=</span> <span class="n">X_train_split</span><span class="p">,</span> <span class="n">X_test_split</span>
<span class="n">x_train</span> <span class="o">=</span> <span class="n">exclude_single_subject_groups</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">covariates</span><span class="p">)</span>

<span class="c1"># Create the neuroharmony model.</span>
<span class="c1"># Here you can establish the range of the hyperparameters random search or give specific values.</span>
<span class="n">harmony</span> <span class="o">=</span> <span class="n">Neuroharmony</span><span class="p">(</span>
    <span class="n">features</span><span class="p">,</span>
    <span class="n">regression_features</span><span class="p">,</span>
    <span class="n">covariates</span><span class="p">,</span>
    <span class="n">eliminate_variance</span><span class="p">,</span>
    <span class="n">param_distributions</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">RandomForestRegressor__n_estimators</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">],</span>
        <span class="n">RandomForestRegressor__random_state</span><span class="o">=</span><span class="p">[</span><span class="mi">42</span><span class="p">,</span> <span class="mi">78</span><span class="p">],</span>
        <span class="n">RandomForestRegressor__warm_start</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
    <span class="p">),</span>
    <span class="n">estimator_args</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">randomized_search_args</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span>
<span class="p">)</span>
<span class="c1"># Fit the model.</span>
<span class="n">x_train_harmonized</span> <span class="o">=</span> <span class="n">harmony</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span>
<span class="c1"># Predict correction to unseen data.</span>
<span class="n">x_test_harmonized</span> <span class="o">=</span> <span class="n">harmony</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span>
<span class="c1"># Compose a NDFrame with all the data.</span>
<span class="n">data_harmonized</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">x_train_harmonized</span><span class="p">,</span> <span class="n">x_test_harmonized</span><span class="p">],</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="c1"># Use Kolmogorov-Smirnov test to stablish if the differences between scanners were indeed eliminated.</span>
<span class="n">KS_ORIGINAL</span> <span class="o">=</span> <span class="n">ks_test_grid</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="s2">&quot;scanner&quot;</span><span class="p">)</span>
<span class="n">KS_HARMONIZED</span> <span class="o">=</span> <span class="n">ks_test_grid</span><span class="p">(</span><span class="n">data_harmonized</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="s2">&quot;scanner&quot;</span><span class="p">)</span>

<span class="n">KS_HARMONIZED_ARRAY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_scanners</span><span class="p">,</span> <span class="n">n_scanners</span><span class="p">,</span> <span class="mi">101</span><span class="p">))</span>
<span class="n">KS_ORIGINAL_ARRAY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_scanners</span><span class="p">,</span> <span class="n">n_scanners</span><span class="p">,</span> <span class="mi">101</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i_var</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rois</span><span class="p">):</span>
    <span class="n">KS_HARMONIZED_ARRAY</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">KS_HARMONIZED</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
    <span class="n">KS_ORIGINAL_ARRAY</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">KS_HARMONIZED</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
<span class="n">MIN_KS_ORIGINAL</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">KS_ORIGINAL_ARRAY</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">scanners</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">scanners</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">MIN_KS_HARMONIZED</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">KS_HARMONIZED_ARRAY</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">scanners</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">scanners</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">MIN_KS</span> <span class="o">=</span> <span class="n">MIN_KS_ORIGINAL</span> <span class="o">+</span> <span class="n">MIN_KS_HARMONIZED</span><span class="o">.</span><span class="n">T</span>

<span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="mf">1e-4</span><span class="p">,</span> <span class="mf">1e0</span>
<span class="n">cbar_ticks</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="o">**</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">vmin</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">vmax</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mf">5.2283465</span><span class="p">,</span> <span class="mf">1.2</span> <span class="o">*</span> <span class="mf">5.2283465</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">heatmap</span><span class="p">(</span><span class="n">MIN_KS</span><span class="p">,</span>
             <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;BrBG&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">),</span>
             <span class="n">cbar_kws</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="n">cbar_ticks</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.005</span><span class="p">),</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Kolmogorov-Smirnov test (p-value)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">minorticks_off</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.175</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.33</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">1.075</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">MIN_KS</span><span class="p">)))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">MIN_KS</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 1 minutes  8.500 seconds)</p>
<div class="sphx-glr-footer class sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-examples-plot-train-neuroharmony-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/4779ff1ded9606d6f12ac6d1cf6498ec/plot_train_neuroharmony.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_train_neuroharmony.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/d6d2e415ca379e1d2e8f5e6c4e6829fe/plot_train_neuroharmony.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_train_neuroharmony.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="plot_neuroharmony_trained.html" class="btn btn-neutral float-left" title="Apply a pre-trained Neuroharmony model" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Rafael Garcia-Dias, Creative Commons.
      <span class="lastupdated">
        Last updated on Aug 05, 2020.
      </span>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>